<!DOCTYPE html>
<html>
  <head>
    <title>* THREADS</title>
    <link rel="stylesheet" href="/static/css/main.css?v=1.3" />
  </head>
  <body>
    <div class="sidebar">
      <h2>* MENU</h2>
      <nav>
        <a href="/main" class="nav-link">* POSTS</a>
        <a href="/threads" class="nav-link active">* THREADS</a>
      </nav>
    </div>

    <div class="main-content">
      <div class="header">
        <h1>* DISCUSSION THREADS</h1>
        <div class="user-info">
          <span>* User: <strong>{{ username }}</strong></span>
          <a href="/logout" class="logout-btn">[EXIT]</a>
        </div>
      </div>

      <!-- Create Thread Form -->
      <div class="create-thread-section">
        <h2>* START NEW THREAD</h2>
        <form method="post" action="/create-thread" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="* Thread title..." required />
          <input type="text" name="tags" placeholder="* Tags (comma-separated)..." />
          <div class="file-upload">
            <label for="attachment">* ATTACHMENT (optional, max 10MB):</label>
            <input type="file" name="attachment" id="attachment" accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.ogg,.mov" />
            <small>* Supported: Images and Videos</small>
          </div>
          <button type="submit">[CREATE]</button>
        </form>
      </div>

      <!-- Tag Filters -->
      {% if all_tags %}
      <div class="tag-filters">
        <span class="filter-label">* FILTER BY TAG:</span>
        <a href="/threads" class="filter-tag {% if not selected_tag %}active{% endif %}">[ALL]</a>
        {% for tag in all_tags %}
        <a href="/threads?tag={{ tag.name }}" class="filter-tag {% if selected_tag == tag.name %}active{% endif %}">#{{ tag.name }}</a>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Thread List -->
      <div class="threads-container">
        {% if threads %}
          {% for thread in threads %}
          <div class="thread-item-wrapper" data-thread-id="{{ thread.id }}">
            {% if is_admin %}
            <button class="admin-delete-btn-thread" onclick="deleteThread({{ thread.id }}, event)" title="Delete thread">✕</button>
            {% endif %}
            <a href="/thread/{{ thread.id }}" class="thread-item">
              <div class="thread-header">
                <h3>* {{ thread.title }}</h3>
                <span class="thread-meta">* by {{ thread.creator_username }} • {{ thread.created_at.strftime('%H:%M %d-%m-%Y') if thread.created_at else 'N/A' }}</span>
              </div>
              {% if thread.tags %}
              <div class="tags">
                {% for tag in thread.tags %}
                <span class="tag">#{{ tag.name }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </a>
          </div>
          {% endfor %}
        {% else %}
          <p class="no-content">* No threads yet. Create one above!</p>
        {% endif %}
      </div>
    </div>

    <script>
      // Admin delete function for threads
      function deleteThread(threadId, event) {
        event.preventDefault();
        event.stopPropagation();

        if (!confirm('* Are you sure you want to delete this thread? This action cannot be undone.')) {
          return;
        }

        const wrapper = document.querySelector(`[data-thread-id="${threadId}"]`);
        const button = wrapper.querySelector('.admin-delete-btn-thread');

        button.disabled = true;
        button.style.opacity = '0.5';

        fetch(`/admin/delete-thread/${threadId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            wrapper.style.opacity = '0';
            setTimeout(() => wrapper.remove(), 300);
          } else {
            alert('* Error deleting thread');
            button.disabled = false;
            button.style.opacity = '1';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('* Error deleting thread');
          button.disabled = false;
          button.style.opacity = '1';
        });
      }
    </script>
  </body>
</html>
