<!DOCTYPE html>
<html>
  <head>
    <title>* POSTS</title>
    <link rel="stylesheet" href="/static/css/main.css?v=1.3" />
  </head>
  <body>
    <div class="sidebar">
      <h2>* MENU</h2>
      <nav>
        <a href="/main" class="nav-link active">* POSTS</a>
        <a href="/threads" class="nav-link">* THREADS</a>
      </nav>
    </div>

    <div class="main-content">
      <div class="header">
        <h1>* POSTS BOARD</h1>
        <div class="user-info">
          <span>* User: <strong>{{ username }}</strong></span>
          <a href="/logout" class="logout-btn">[EXIT]</a>
        </div>
      </div>

      <!-- Tag Filters -->
      {% if all_tags %}
      <div class="tag-filters">
        <span class="filter-label">* FILTER BY TAG:</span>
        <a href="/main" class="filter-tag {% if not selected_tag %}active{% endif %}">[ALL]</a>
        {% for tag in all_tags %}
        <a href="/main?tag={{ tag.name }}" class="filter-tag {% if selected_tag == tag.name %}active{% endif %}">#{{ tag.name }}</a>
        {% endfor %}
      </div>
      {% endif %}

    {% if posts %} {% for post in posts %}
    <div class="post" data-post-id="{{ post.id }}">
      <div class="post-number">POST #{{ loop.index }}</div>
      {% if is_admin %}
      <button class="admin-delete-btn" onclick="deletePost({{ post.id }}, this)" title="Delete post">✕</button>
      {% endif %}
      <div class="post-header">
        <h2>{{ post.title }}</h2>
        <div class="post-meta">
          <span class="author">{{ post.author_username }}</span>
          <span class="timestamp">{{ post.created_at.strftime('%H:%M %d-%m-%Y') if post.created_at else 'N/A' }}</span>
        </div>
      </div>
      <!-- Nested content blocks -->
      {% if post.content_blocks %}
        {% set blocks = post.content_blocks | from_json %}
        <div class="post-content-blocks">
          {% for block in blocks %}
            {% if block.type == 'text' %}
              <div class="content-text-block">{{ block.content }}</div>
            {% elif block.type == 'image' %}
              <div class="content-image-block">
                <img src="{{ block.content }}" alt="Post image" />
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p>{{ post.content }}</p>
      {% endif %}

      {% if post.tags %}
      <div class="tags">
        {% for tag in post.tags %}
        <span class="tag">#{{ tag.name }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Post Reactions -->
      <div class="reactions">
        <span class="reaction-label">* DETERMINATION:</span>
        <form method="post" action="/post/{{ post.id }}/react" style="display: inline;">
          <input type="hidden" name="reaction_type" value="upvote">
          <button type="submit" class="reaction-btn upvote">
            ▲ {{ post.reactions|selectattr('reaction_type', 'equalto', 'upvote')|list|length }}
          </button>
        </form>
        <form method="post" action="/post/{{ post.id }}/react" style="display: inline;">
          <input type="hidden" name="reaction_type" value="downvote">
          <button type="submit" class="reaction-btn downvote">
            ▼ {{ post.reactions|selectattr('reaction_type', 'equalto', 'downvote')|list|length }}
          </button>
        </form>
      </div>

      <!-- Comments Section -->
      <div class="comments-section">
        <h3>* COMMENTS ({{ post.comments|length }})</h3>

        {% if post.comments %}
        <div class="comments-list">
          {% for comment in post.comments %}
          <div class="comment" data-comment-id="{{ comment.id }}">
            {% if is_admin %}
            <button class="admin-delete-btn-comment" onclick="deleteComment({{ comment.id }}, this)" title="Delete comment">✕</button>
            {% endif %}
            <div class="comment-header">
              <span class="comment-author">{{ comment.author_username }}</span>
              <span class="comment-time">{{ comment.created_at.strftime('%H:%M') if comment.created_at else 'N/A' }}</span>
            </div>
            <p class="comment-content">{{ comment.content }}</p>

            <!-- Comment Reactions -->
            <div class="comment-reactions">
              <form method="post" action="/comment/{{ comment.id }}/react" style="display: inline;">
                <input type="hidden" name="reaction_type" value="upvote">
                <button type="submit" class="reaction-btn-small upvote">
                  ▲ {{ comment.reactions|selectattr('reaction_type', 'equalto', 'upvote')|list|length }}
                </button>
              </form>
              <form method="post" action="/comment/{{ comment.id }}/react" style="display: inline;">
                <input type="hidden" name="reaction_type" value="downvote">
                <button type="submit" class="reaction-btn-small downvote">
                  ▼ {{ comment.reactions|selectattr('reaction_type', 'equalto', 'downvote')|list|length }}
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Add Comment Form -->
        <form method="post" action="/post/{{ post.id }}/comment" class="comment-form">
          <input type="text" name="content" placeholder="* What are your thoughts?" required>
          <button type="submit">[POST]</button>
        </form>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="no-content">
      <p>* No posts found.</p>
      <p>* The board is empty...</p>
    </div>
    {% endif %}

      <div class="link">
        <a href="/create">* CREATE NEW POST</a>
      </div>
    </div>

    <script>
      // AJAX function for post reactions
      function reactToPost(postId, reactionType, button) {
        // Add loading state
        button.classList.add('loading');
        const post = document.querySelector(`[data-post-id="${postId}"]`);
        const reactions = post.querySelector('.reactions');
        reactions.classList.add('updating');

        const formData = new FormData();
        formData.append('reaction_type', reactionType);

        fetch(`/post/${postId}/react`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            // Update the count in the button
            return fetch(window.location.href)
              .then(res => res.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newPost = doc.querySelector(`[data-post-id="${postId}"]`);
                const currentPost = document.querySelector(`[data-post-id="${postId}"]`);

                if (newPost && currentPost) {
                  const newReactions = newPost.querySelector('.reactions');
                  const currentReactions = currentPost.querySelector('.reactions');
                  if (newReactions && currentReactions) {
                    currentReactions.innerHTML = newReactions.innerHTML;
                    currentReactions.classList.remove('updating');
                    // Re-attach event listeners
                    attachReactionListeners(currentPost);
                  }
                }
              });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          button.classList.remove('loading');
          reactions.classList.remove('updating');
        });
      }

      // AJAX function for comment reactions
      function reactToComment(commentId, reactionType, button) {
        // Add loading state
        button.classList.add('loading');
        const comment = document.querySelector(`[data-comment-id="${commentId}"]`);
        comment.classList.add('updating');

        const formData = new FormData();
        formData.append('reaction_type', reactionType);

        fetch(`/comment/${commentId}/react`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            return fetch(window.location.href)
              .then(res => res.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newComment = doc.querySelector(`[data-comment-id="${commentId}"]`);
                const currentComment = document.querySelector(`[data-comment-id="${commentId}"]`);

                if (newComment && currentComment) {
                  const newReactions = newComment.querySelector('.comment-reactions');
                  const currentReactions = currentComment.querySelector('.comment-reactions');
                  if (newReactions && currentReactions) {
                    currentReactions.innerHTML = newReactions.innerHTML;
                    currentComment.classList.remove('updating');
                    attachCommentReactionListeners(currentComment);
                  }
                }
              });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          button.classList.remove('loading');
          comment.classList.remove('updating');
        });
      }

      // AJAX function for adding comments
      function addComment(postId, form) {
        // Add submitting state
        form.classList.add('submitting');

        const formData = new FormData(form);

        fetch(`/post/${postId}/comment`, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            // Clear the input
            form.querySelector('input[name="content"]').value = '';

            // Reload comments section
            return fetch(window.location.href)
              .then(res => res.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newPost = doc.querySelector(`[data-post-id="${postId}"]`);
                const currentPost = document.querySelector(`[data-post-id="${postId}"]`);

                if (newPost && currentPost) {
                  const newCommentsSection = newPost.querySelector('.comments-section');
                  const currentCommentsSection = currentPost.querySelector('.comments-section');
                  if (newCommentsSection && currentCommentsSection) {
                    currentCommentsSection.innerHTML = newCommentsSection.innerHTML;
                    form.classList.remove('submitting');
                    // Re-attach all event listeners
                    attachCommentListeners(currentPost);
                  }
                }
              });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          form.classList.remove('submitting');
        });
      }

      // Attach event listeners to reaction buttons
      function attachReactionListeners(post) {
        const reactionButtons = post.querySelectorAll('.reactions .reaction-btn');
        reactionButtons.forEach(btn => {
          btn.onclick = function(e) {
            e.preventDefault();
            const postId = post.dataset.postId;
            const reactionType = this.closest('form').querySelector('input[name="reaction_type"]').value;
            reactToPost(postId, reactionType, this);
          };
        });
      }

      // Attach event listeners to comment reaction buttons
      function attachCommentReactionListeners(comment) {
        const reactionButtons = comment.querySelectorAll('.comment-reactions .reaction-btn-small');
        reactionButtons.forEach(btn => {
          btn.onclick = function(e) {
            e.preventDefault();
            const commentId = comment.dataset.commentId;
            const reactionType = this.closest('form').querySelector('input[name="reaction_type"]').value;
            reactToComment(commentId, reactionType, this);
          };
        });
      }

      // Attach event listeners to comment forms
      function attachCommentListeners(post) {
        const commentForm = post.querySelector('.comment-form');
        if (commentForm) {
          commentForm.onsubmit = function(e) {
            e.preventDefault();
            const postId = post.dataset.postId;
            addComment(postId, this);
          };
        }

        // Re-attach comment reaction listeners
        const comments = post.querySelectorAll('.comment');
        comments.forEach(comment => {
          attachCommentReactionListeners(comment);
        });
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        const posts = document.querySelectorAll('.post');
        posts.forEach(post => {
          attachReactionListeners(post);
          attachCommentListeners(post);
        });
      });

      // Admin delete functions
      function deletePost(postId, button) {
        if (!confirm('* Are you sure you want to delete this post? This action cannot be undone.')) {
          return;
        }

        button.disabled = true;
        button.style.opacity = '0.5';

        fetch(`/admin/delete-post/${postId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            const post = document.querySelector(`[data-post-id="${postId}"]`);
            if (post) {
              post.style.opacity = '0';
              setTimeout(() => post.remove(), 300);
            }
          } else {
            alert('* Error deleting post');
            button.disabled = false;
            button.style.opacity = '1';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('* Error deleting post');
          button.disabled = false;
          button.style.opacity = '1';
        });
      }

      function deleteComment(commentId, button) {
        if (!confirm('* Are you sure you want to delete this comment?')) {
          return;
        }

        button.disabled = true;
        button.style.opacity = '0.5';

        fetch(`/admin/delete-comment/${commentId}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            const comment = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (comment) {
              comment.style.opacity = '0';
              setTimeout(() => {
                comment.remove();
                // Update comment count
                const post = button.closest('.post');
                const commentsHeader = post.querySelector('.comments-section h3');
                const currentCount = post.querySelectorAll('.comment').length;
                commentsHeader.textContent = `* COMMENTS (${currentCount - 1})`;
              }, 300);
            }
          } else {
            alert('* Error deleting comment');
            button.disabled = false;
            button.style.opacity = '1';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('* Error deleting comment');
          button.disabled = false;
          button.style.opacity = '1';
        });
      }
    </script>
  </body>
</html>
