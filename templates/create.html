<!DOCTYPE html>
<html>
  <head>
    <title>* CREATE POST</title>
    <link rel="stylesheet" href="/static/css/main.css?v=1.3" />
    <link rel="stylesheet" href="/static/css/create.css" />
    <style>
      .content-blocks-container {
        margin: 20px 0;
        border: 1px solid #ffffff;
        padding: 15px;
        background-color: #0f0f0f;
      }

      .content-block {
        background-color: #0a0a0a;
        border: 1px solid #cccccc;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
      }

      .block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #cccccc;
      }

      .block-type-label {
        color: #ffffff;
        font-weight: bold;
        font-size: 12px;
      }

      .block-controls {
        display: flex;
        gap: 5px;
      }

      .control-btn {
        background-color: #0f0f0f;
        border: 1px solid #cccccc;
        color: #ffffff;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
      }

      .control-btn:hover {
        background-color: #ffffff;
        color: #000000;
      }

      .control-btn.delete {
        border-color: #ff0000;
        color: #ff0000;
      }

      .control-btn.delete:hover {
        background-color: #ff0000;
        color: #ffffff;
      }

      .content-block textarea {
        width: 100%;
        background-color: #0f0f0f;
        border: 1px solid #cccccc;
        color: #ffffff;
        padding: 10px;
        font-family: 'Courier New', monospace;
        resize: vertical;
        min-height: 100px;
      }

      .content-block img {
        max-width: 100%;
        border: 1px solid #ffffff;
        margin-top: 10px;
      }

      .content-block video {
        max-width: 100%;
        border: 1px solid #ffffff;
        margin-top: 10px;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .toolbar-btn {
        background-color: #0f0f0f;
        border: 1px solid #ffffff;
        color: #ffffff;
        padding: 10px 20px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
      }

      .toolbar-btn:hover {
        background-color: #ffffff;
        color: #000000;
      }

      .loading-indicator {
        text-align: center;
        color: #ffffff;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>* MENU</h2>
      <nav>
        <a href="/main" class="nav-link active">* POSTS</a>
        <a href="/threads" class="nav-link">* THREADS</a>
      </nav>
    </div>

    <div class="main-content">
      <div class="header">
        <h1>* CREATE NEW POST</h1>
        <div class="user-info">
          <span>* User: <strong>{{ username }}</strong></span>
          <a href="/logout" class="logout-btn">[EXIT]</a>
        </div>
      </div>

      <form method="post" action="/create" id="postForm">
        <div class="form-group">
          <label for="title">* POST TITLE:</label>
          <input type="text" id="title" name="title" placeholder="Enter a descriptive title..." required maxlength="200" />
          <small class="help-text">* Required - Max 200 characters</small>
        </div>

        <div class="form-group">
          <label for="tags">* TAGS:</label>
          <input type="text" id="tags" name="tags" placeholder="e.g., gaming, discussion, question" />
          <small class="help-text">* Optional - Comma-separated tags</small>
        </div>

        <div class="form-group">
          <label>* CONTENT BLOCKS:</label>
          <div class="toolbar">
            <button type="button" class="toolbar-btn" onclick="addTextBlock()">[+ ADD TEXT]</button>
            <button type="button" class="toolbar-btn" onclick="addImageBlock()">[+ ADD IMAGE]</button>
            <button type="button" class="toolbar-btn" onclick="addVideoBlock()">[+ ADD VIDEO]</button>
          </div>
          <div class="content-blocks-container" id="contentBlocksContainer">
            <p style="color: #cccccc; text-align: center;">* Click [+ ADD TEXT], [+ ADD IMAGE], or [+ ADD VIDEO] to start building your post</p>
          </div>
          <small class="help-text">* Add content blocks in any order: text, images, videos</small>
        </div>

        <input type="hidden" name="blocks" id="blocksData" />

        <div class="form-actions">
          <button type="submit" class="submit-btn" onclick="return prepareSubmit()">[CREATE POST]</button>
          <a href="/main" class="cancel-btn">[CANCEL]</a>
        </div>
      </form>

      <div class="link">
        <a href="/main">← [BACK TO BOARD]</a>
      </div>
    </div>

    <script>
      let blockCounter = 0;

      function addTextBlock() {
        const id = blockCounter++;
        const blockHtml = `
          <div class="content-block" data-id="${id}" data-type="text">
            <div class="block-header">
              <span class="block-type-label">TEXT BLOCK #${id + 1}</span>
              <div class="block-controls">
                <button type="button" class="control-btn" onclick="moveBlockUp(${id})">▲</button>
                <button type="button" class="control-btn" onclick="moveBlockDown(${id})">▼</button>
                <button type="button" class="control-btn delete" onclick="removeBlock(${id})">✕</button>
              </div>
            </div>
            <textarea placeholder="* Enter your text here..." rows="5"></textarea>
          </div>
        `;
        document.getElementById('contentBlocksContainer').insertAdjacentHTML('beforeend', blockHtml);
        updateEmptyState();
      }

      function addImageBlock() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          if (file.size > 10 * 1024 * 1024) {
            alert('* Error: Image must be less than 10MB');
            return;
          }

          const formData = new FormData();
          formData.append('image', file);

          const loadingId = blockCounter++;
          const loadingHtml = `
            <div class="content-block loading" data-id="${loadingId}" data-type="loading">
              <div class="loading-indicator">* Uploading image...</div>
            </div>
          `;
          document.getElementById('contentBlocksContainer').insertAdjacentHTML('beforeend', loadingHtml);
          updateEmptyState();

          try {
            const response = await fetch('/upload-image', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();

            document.querySelector(`[data-id="${loadingId}"]`).remove();

            if (data.success) {
              const id = blockCounter++;
              const blockHtml = `
                <div class="content-block" data-id="${id}" data-type="image" data-url="${data.url}">
                  <div class="block-header">
                    <span class="block-type-label">IMAGE BLOCK #${id + 1}</span>
                    <div class="block-controls">
                      <button type="button" class="control-btn" onclick="moveBlockUp(${id})">▲</button>
                      <button type="button" class="control-btn" onclick="moveBlockDown(${id})">▼</button>
                      <button type="button" class="control-btn delete" onclick="removeBlock(${id})">✕</button>
                    </div>
                  </div>
                  <img src="${data.url}" alt="Uploaded image" />
                </div>
              `;
              document.getElementById('contentBlocksContainer').insertAdjacentHTML('beforeend', blockHtml);
              updateEmptyState();
            } else {
              alert('* Error uploading image');
            }
          } catch (error) {
            document.querySelector(`[data-id="${loadingId}"]`).remove();
            alert('* Error uploading image: ' + error.message);
            updateEmptyState();
          }
        };
        input.click();
      }

      function addVideoBlock() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          if (file.size > 10 * 1024 * 1024) {
            alert('* Error: Video must be less than 10MB');
            return;
          }

          const formData = new FormData();
          formData.append('video', file);

          const loadingId = blockCounter++;
          const loadingHtml = `
            <div class="content-block loading" data-id="${loadingId}" data-type="loading">
              <div class="loading-indicator">* Uploading video...</div>
            </div>
          `;
          document.getElementById('contentBlocksContainer').insertAdjacentHTML('beforeend', loadingHtml);
          updateEmptyState();

          try {
            const response = await fetch('/upload-video', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();

            document.querySelector(`[data-id="${loadingId}"]`).remove();

            if (data.success) {
              const id = blockCounter++;
              const blockHtml = `
                <div class="content-block" data-id="${id}" data-type="video" data-url="${data.url}">
                  <div class="block-header">
                    <span class="block-type-label">VIDEO BLOCK #${id + 1}</span>
                    <div class="block-controls">
                      <button type="button" class="control-btn" onclick="moveBlockUp(${id})">▲</button>
                      <button type="button" class="control-btn" onclick="moveBlockDown(${id})">▼</button>
                      <button type="button" class="control-btn delete" onclick="removeBlock(${id})">✕</button>
                    </div>
                  </div>
                  <video controls>
                    <source src="${data.url}" type="${file.type}">
                  </video>
                </div>
              `;
              document.getElementById('contentBlocksContainer').insertAdjacentHTML('beforeend', blockHtml);
              updateEmptyState();
            } else {
              alert('* Error uploading video');
            }
          } catch (error) {
            document.querySelector(`[data-id="${loadingId}"]`).remove();
            alert('* Error uploading video: ' + error.message);
            updateEmptyState();
          }
        };
        input.click();
      }

      function removeBlock(id) {
        const block = document.querySelector(`[data-id="${id}"]`);
        if (block && confirm('* Remove this block?')) {
          block.remove();
          updateEmptyState();
        }
      }

      function moveBlockUp(id) {
        const block = document.querySelector(`[data-id="${id}"]`);
        const prev = block.previousElementSibling;
        if (prev && !prev.classList.contains('loading')) {
          block.parentNode.insertBefore(block, prev);
        }
      }

      function moveBlockDown(id) {
        const block = document.querySelector(`[data-id="${id}"]`);
        const next = block.nextElementSibling;
        if (next) {
          block.parentNode.insertBefore(next, block);
        }
      }

      function updateEmptyState() {
        const container = document.getElementById('contentBlocksContainer');
        const blocks = container.querySelectorAll('.content-block:not(.loading)');
        if (blocks.length === 0) {
          container.innerHTML = '<p style="color: #cccccc; text-align: center;">* Click [+ ADD TEXT], [+ ADD IMAGE], or [+ ADD VIDEO] to start building your post</p>';
        } else {
          const emptyMsg = container.querySelector('p');
          if (emptyMsg && emptyMsg.textContent.includes('Click')) {
            emptyMsg.remove();
          }
        }
      }

      function prepareSubmit() {
        const blocks = [];
        const blockElements = document.querySelectorAll('.content-block:not(.loading)');

        if (blockElements.length === 0) {
          alert('* Please add at least one content block');
          return false;
        }

        blockElements.forEach(block => {
          const type = block.dataset.type;
          if (type === 'text') {
            const textarea = block.querySelector('textarea');
            const content = textarea.value.trim();
            if (content) {
              blocks.push({ type: 'text', content: content });
            }
          } else if (type === 'image') {
            blocks.push({ type: 'image', url: block.dataset.url });
          } else if (type === 'video') {
            blocks.push({ type: 'video', url: block.dataset.url });
          }
        });

        if (blocks.length === 0) {
          alert('* Please add content to your blocks');
          return false;
        }

        document.getElementById('blocksData').value = JSON.stringify(blocks);
        return true;
      }

      // Initialize with one text block
      addTextBlock();
    </script>
  </body>
</html>
